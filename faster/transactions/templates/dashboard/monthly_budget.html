{% extends "base.html" %}
{% load humanize %}

{% block content %}
<!-- Hero Section -->
<div class="mb-8">
  <h1 class="text-4xl font-bold text-gray-900 mb-2">
    <i class="bi bi-calendar-month text-indigo-600"></i>
    Monthly Budget & Trends
  </h1>
  <p class="text-gray-600">
    Analyze your spending patterns across categories with historical averages
  </p>
</div>

<!-- Current Month Overview -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <!-- Total Spending This Month -->
  <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500 hover:shadow-xl transition duration-300">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 uppercase">This Month's Spending</p>
        <p class="text-3xl font-bold text-gray-900 mt-2">
          {{ current_month_total|floatformat:0|intcomma }} <span class="text-xl font-semibold text-gray-500">{{ primary_currency }}</span>
        </p>
        <p class="text-xs text-gray-500 mt-1">{{ current_month }}</p>
      </div>
      <div class="bg-red-100 rounded-full p-3">
        <i class="bi bi-calendar-fill text-red-600 text-2xl"></i>
      </div>
    </div>
  </div>

  <!-- Average Monthly Spending -->
  <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-500 hover:shadow-xl transition duration-300">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 uppercase">Average / Month</p>
        <p class="text-3xl font-bold text-gray-900 mt-2">
          {{ average_spending|floatformat:0|intcomma }} <span class="text-xl font-semibold text-gray-500">{{ primary_currency }}</span>
        </p>
        <p class="text-xs text-gray-500 mt-1">Across all categories</p>
      </div>
      <div class="bg-orange-100 rounded-full p-3">
        <i class="bi bi-graph-up text-orange-600 text-2xl"></i>
      </div>
    </div>
  </div>

  <!-- Number of Categories -->
  <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500 hover:shadow-xl transition duration-300">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 uppercase">Categories</p>
        <p class="text-3xl font-bold text-gray-900 mt-2">
          {{ category_stats|length }}
        </p>
        <p class="text-xs text-gray-500 mt-1">Being tracked</p>
      </div>
      <div class="bg-purple-100 rounded-full p-3">
        <i class="bi bi-tags-fill text-purple-600 text-2xl"></i>
      </div>
    </div>
  </div>
</div>

<!-- Average Spending by Category Chart -->
<div class="grid grid-cols-1 lg:grid-cols-1 gap-6 mb-8">
  <!-- Bar Chart -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition duration-300">
    <div class="bg-gradient-to-r from-indigo-500 to-blue-500 px-6 py-4">
      <h2 class="text-xl font-bold text-white flex items-center">
        <i class="bi bi-bar-chart-fill mr-2"></i>
        Average Spending by Category
      </h2>
    </div>
    <div class="p-6">
      <div class="flex justify-center">
        <div class="w-full" style="height: 600px;">
          <canvas id="averageSpendingChart"></canvas>
        </div>
      </div>
    </div>
  </div>

<!-- Detailed Category Statistics Table -->
<div class="bg-white rounded-xl shadow-md overflow-hidden">
  <div class="bg-gradient-to-r from-green-500 to-emerald-500 px-6 py-4">
    <h2 class="text-xl font-bold text-white flex items-center">
      <i class="bi bi-table mr-2"></i>
      Category Spending Analysis
    </h2>
    <p class="text-green-100 text-sm mt-1">Historical averages and current month spending</p>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Category</th>
          <th class="px-6 py-3 text-right text-sm font-semibold text-gray-900">This Month</th>
          <th class="px-6 py-3 text-right text-sm font-semibold text-gray-900">Average</th>
          <th class="px-6 py-3 text-right text-sm font-semibold text-gray-900">Min</th>
          <th class="px-6 py-3 text-right text-sm font-semibold text-gray-900">Max</th>
          <th class="px-6 py-3 text-right text-sm font-semibold text-gray-900">vs Average</th>
          <th class="px-6 py-3 text-right text-sm font-semibold text-gray-900">Months Tracked</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for item in category_rows %}
          {% if item.is_over_budget %}
            <tr class="hover:bg-red-50 transition">
          {% elif item.current_amount > 0 %}
            <tr class="hover:bg-green-50 transition">
          {% else %}
            <tr class="hover:bg-gray-50 transition">
          {% endif %}
            <td class="px-6 py-4">
              <p class="font-medium text-gray-900">{{ item.category }}</p>
            </td>
            <td class="px-6 py-4 text-right">
              <p class="text-gray-900 font-semibold">
                {% if item.current_amount > 0 %}
                  {{ item.current_amount|floatformat:0|intcomma }}
                {% else %}
                  <span class="text-gray-400">-</span>
                {% endif %}
              </p>
            </td>
            <td class="px-6 py-4 text-right">
              <p class="text-gray-900 font-semibold">{{ item.average|floatformat:0|intcomma }}</p>
            </td>
            <td class="px-6 py-4 text-right">
              <p class="text-gray-600">{{ item.min|floatformat:0|intcomma }}</p>
            </td>
            <td class="px-6 py-4 text-right">
              <p class="text-gray-600">{{ item.max|floatformat:0|intcomma }}</p>
            </td>
            <td class="px-6 py-4 text-right">
              {% if item.current_amount > 0 %}
                {% if item.is_over_budget %}
                  <span class="inline-flex items-center space-x-1 text-red-600 font-semibold">
                    <i class="bi bi-arrow-up"></i>
                    <span>+{{ item.difference|floatformat:0|intcomma }}</span>
                  </span>
                {% else %}
                  <span class="inline-flex items-center space-x-1 text-green-600 font-semibold">
                    <i class="bi bi-arrow-down"></i>
                    <span>{{ item.difference|floatformat:0|intcomma }}</span>
                  </span>
                {% endif %}
              {% else %}
                <span class="text-gray-400">-</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 text-right">
              <p class="text-gray-600">{{ item.count }}</p>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="px-6 py-8 text-center text-gray-500">
              <i class="bi bi-inbox text-4xl mb-2"></i>
              <p class="text-lg font-medium">No spending data available</p>
              <p class="text-sm mt-1">Start by uploading your bank statements</p>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Filters Section -->
<div class="mt-8 bg-white rounded-xl shadow-md overflow-hidden">
  <div class="bg-gradient-to-r from-gray-500 to-slate-500 px-6 py-4">
    <h2 class="text-xl font-bold text-white flex items-center">
      <i class="bi bi-funnel mr-2"></i>
      Filters
    </h2>
  </div>
  <div class="p-6">
    <form method="POST" class="space-y-4">
      {% csrf_token %}
      
      <!-- File Selection -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Data Sources</label>
        <div class="space-y-2">
          {% for file in files %}
            <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="file" value="{{ file.id }}" 
                     {% if file.id|stringformat:"s" in selected_file_ids %}checked{% endif %}
                     class="w-4 h-4 text-indigo-600 rounded">
              <span class="ml-2 text-gray-900">{{ file.name }}</span>
              <span class="ml-auto text-xs text-gray-500">{{ file.uploaded_at|date:"M d, Y" }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <!-- Currency Selection -->
      {% if all_currencies %}
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Currencies</label>
          <div class="space-y-2">
            {% for currency in all_currencies %}
              <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" name="currency" value="{{ currency }}"
                       {% if currency in selected_currencies %}checked{% endif %}
                       class="w-4 h-4 text-indigo-600 rounded">
                <span class="ml-2 text-gray-900">{{ currency }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition">
        Update Filters
      </button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Parse chart data
  const chartDataStr = '{{ chart_data|safe|escapejs }}';
  const chartData = JSON.parse(chartDataStr);

  // Create average spending chart
  const ctxAverage = document.getElementById('averageSpendingChart').getContext('2d');
  
  const colors = [
    '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16',
    '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9'
  ];

  new Chart(ctxAverage, {
    type: 'bar',
    data: {
      labels: chartData.labels,
      datasets: [{
        label: 'Average Monthly Spending',
        data: chartData.averages,
        backgroundColor: colors.slice(0, chartData.labels.length),
        borderRadius: 8,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: {
          display: false,
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'CHF ' + context.parsed.x.toLocaleString('en-US', { maximumFractionDigits: 0 });
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value.toLocaleString('en-US', { maximumFractionDigits: 0 });
            },
            color: '#6b7280'
          }
        },
        y: {
          ticks: {
            color: '#6b7280'
          }
        }
      }
    }
  });

  // Helper function to get item from dict in template
  function getItemValue(obj, key) {
    return obj[key] || 0;
  }
</script>

<!-- Template filters for dict access -->
<script>
  // Since Django template doesn't have dict access in some versions,
  // we can use this as fallback
</script>
{% endblock %}
