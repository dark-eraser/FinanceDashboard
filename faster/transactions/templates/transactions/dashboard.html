{% extends "base.html" %}
{% load humanize %}

{% block content %}
<!-- Hero Section -->
<div class="mb-8">
  <h1 class="text-4xl font-bold text-gray-900 mb-2">
    <i class="bi bi-speedometer2 text-indigo-600"></i>
    Financial Dashboard
  </h1>
  <p class="text-gray-600">
    Track your income, expenses, and financial insights at a glance
  </p>
</div>

<!-- Summary Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
  <!-- Total Expenses Card -->
  <div
    class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500 hover:shadow-xl transition duration-300"
  >
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 uppercase">Top Expense</p>
        {% if top_spending %}
          <p class="text-3xl font-bold text-gray-900 mt-2">
            {{ top_spending.0.total|floatformat:0|intcomma }}
            <span class="text-base text-gray-500">
              {% for currency, amount in top_spending.0.currencies.items %}
                {{ currency }}{% if not forloop.last %}/{% endif %}
              {% endfor %}
            </span>
          </p>
          <p class="text-xs text-gray-500 mt-1">{{ top_spending.0.category }}</p>
        {% else %}
          <p class="text-3xl font-bold text-gray-400 mt-2">-</p>
        {% endif %}
      </div>
      <div class="bg-red-100 rounded-full p-3">
        <i class="bi bi-arrow-down-circle text-red-600 text-2xl"></i>
      </div>
    </div>
  </div>

  <!-- Total Income Card -->
  <div
    class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-xl transition duration-300"
  >
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600 uppercase">Top Income</p>
        {% if top_income %}
          <p class="text-3xl font-bold text-gray-900 mt-2">
            {{ top_income.0.total|floatformat:0|intcomma }}
            <span class="text-base text-gray-500">
              {% for currency, amount in top_income.0.currencies.items %}
                {{ currency }}{% if not forloop.last %}/{% endif %}
              {% endfor %}
            </span>
          </p>
          <p class="text-xs text-gray-500 mt-1">{{ top_income.0.category }}</p>
        {% else %}
          <p class="text-3xl font-bold text-gray-400 mt-2">-</p>
        {% endif %}
      </div>
      <div class="bg-green-100 rounded-full p-3">
        <i class="bi bi-arrow-up-circle text-green-600 text-2xl"></i>
      </div>
    </div>
  </div>
</div>

<!-- Main Content Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Top Spending Categories -->
    <div
      class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition duration-300"
    >
      <div class="bg-gradient-to-r from-red-500 to-pink-500 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="bi bi-pie-chart-fill mr-2"></i>
          Top Spending Categories
        </h2>
      </div>
      <div class="p-6">
        {% if top_spending %}
          <div class="flex justify-center mb-6">
            <div class="w-80 h-80">
              <canvas id="spendingPieChart"></canvas>
            </div>
          </div>
          <div class="space-y-2">
            {% for item in top_spending %}
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-3">
                  <div class="w-4 h-4 rounded-full" style="background-color: {{ item.color }}"></div>
                  <p class="font-medium text-gray-900 text-sm">{{ item.category }}</p>
                </div>
                <p class="text-sm font-bold text-gray-700">
                  {{ item.total|floatformat:2|intcomma }}
                  <span class="text-xs text-gray-500">
                    {% for currency, amount in item.currencies.items %}
                      {{ currency }}{% if not forloop.last %}/{% endif %}
                    {% endfor %}
                  </span>
                </p>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-12">
            <i class="bi bi-inbox text-gray-300 text-5xl"></i>
            <p class="text-gray-500 mt-4">No expense data available</p>
            <p class="text-sm text-gray-400 mt-2">
              Upload your bank statements to get started
            </p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Top Income Categories -->
    <div
      class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition duration-300"
    >
      <div class="bg-gradient-to-r from-green-500 to-emerald-500 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="bi bi-pie-chart-fill mr-2"></i>
          Top Income Categories
        </h2>
      </div>
      <div class="p-6">
        {% if top_income %}
          <div class="flex justify-center mb-6">
            <div class="w-80 h-80">
              <canvas id="incomePieChart"></canvas>
            </div>
          </div>
          <div class="space-y-2">
            {% for item in top_income %}
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center space-x-3">
                  <div class="w-4 h-4 rounded-full" style="background-color: {{ item.color }}"></div>
                  <p class="font-medium text-gray-900 text-sm">{{ item.category }}</p>
                </div>
                <p class="text-sm font-bold text-gray-700">
                  {{ item.total|floatformat:2|intcomma }}
                  <span class="text-xs text-gray-500">
                    {% for currency, amount in item.currencies.items %}
                      {{ currency }}{% if not forloop.last %}/{% endif %}
                    {% endfor %}
                  </span>
                </p>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-12">
            <i class="bi bi-inbox text-gray-300 text-5xl"></i>
          <p class="text-gray-500 mt-4">No income data available</p>
          <p class="text-sm text-gray-400 mt-2">
            Upload your bank statements to get started
          </p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div
    class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-8 text-white mb-8"
  >
    <div class="flex flex-col md:flex-row items-center justify-between">
      <div class="mb-4 md:mb-0">
        <h3 class="text-2xl font-bold mb-2">Ready to analyze more?</h3>
        <p class="text-indigo-100">
          Upload bank statements, manage filters, and explore detailed analytics
        </p>
      </div>
      <div class="flex space-x-4">
        <a
          href="{% url 'settings' %}"
          class="bg-white text-indigo-600 px-6 py-3 rounded-lg font-semibold hover:bg-indigo-50 transition duration-200 flex items-center space-x-2"
        >
          <i class="bi bi-upload"></i>
          <span>Upload Data</span>
        </a>
        <a
          href="/expenses-vs-income/"
          class="bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-800 transition duration-200 flex items-center space-x-2"
        >
          <i class="bi bi-graph-up"></i>
          <span>View Analytics</span>
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  // Spending Pie Chart
  {% if top_spending %}
  const spendingCtx = document.getElementById('spendingPieChart').getContext('2d');
  const spendingData = {
    labels: [{% for item in top_spending %}'{{ item.category }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
    datasets: [{
      data: [{% for item in top_spending %}{{ item.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
      backgroundColor: [
        '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16',
        '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9'
      ],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  };
  
  new Chart(spendingCtx, {
    type: 'doughnut',
    data: spendingData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              let value = context.parsed || 0;
              let total = context.dataset.data.reduce((a, b) => a + b, 0);
              let percentage = ((value / total) * 100).toFixed(1);
              return label + ': ' + value.toLocaleString() + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
  {% endif %}

  // Income Pie Chart
  {% if top_income %}
  const incomeCtx = document.getElementById('incomePieChart').getContext('2d');
  const incomeData = {
    labels: [{% for item in top_income %}'{{ item.category }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
    datasets: [{
      data: [{% for item in top_income %}{{ item.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
      backgroundColor: [
        '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9',
        '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef'
      ],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  };
  
  new Chart(incomeCtx, {
    type: 'doughnut',
    data: incomeData,
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              let value = context.parsed || 0;
              let total = context.dataset.data.reduce((a, b) => a + b, 0);
              let percentage = ((value / total) * 100).toFixed(1);
              return label + ': ' + value.toLocaleString() + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
  {% endif %}
</script>

{% endblock %}
