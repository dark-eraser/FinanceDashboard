{% extends "base.html" %}
{% load humanize %}
{% csrf_token %}

{% block content %}
<div class="mb-8">
  <h1 class="text-4xl font-bold text-gray-900 mb-2">
    <i class="bi bi-gear text-indigo-600"></i>
    Settings
  </h1>
  <p class="text-gray-600">
    Manage your application settings and AI categorization preferences
  </p>
</div>

<!-- Tab Navigation -->
<div class="mb-8">
  <div class="flex space-x-1 border-b border-gray-200 bg-white rounded-lg">
    <button class="settings-tab px-6 py-3 font-medium border-b-2 border-indigo-600 text-indigo-600 transition"
            data-tab="upload">
      <i class="bi bi-cloud-upload mr-2"></i>Upload Files
    </button>
    <button class="settings-tab px-6 py-3 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300 transition"
            data-tab="categorization">
      <i class="bi bi-robot mr-2"></i>AI Categorization
    </button>
    <button class="settings-tab px-6 py-3 font-medium border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300 transition"
            data-tab="data">
      <i class="bi bi-database mr-2"></i>Data Management
    </button>
  </div>
</div>

<!-- Tab 1: Upload Files -->
<div id="upload-tab" class="settings-content">
  <div class="bg-white rounded-xl shadow-md overflow-hidden">
    <div class="bg-gradient-to-r from-indigo-500 to-blue-500 px-6 py-4">
      <h2 class="text-xl font-bold text-white flex items-center">
        <i class="bi bi-cloud-upload mr-2"></i>
        Upload Bank Statements
      </h2>
    </div>
    <div class="p-6">
      <div class="bg-blue-50 border-2 border-dashed border-blue-300 rounded-lg p-8 text-center cursor-pointer hover:bg-blue-100 transition"
           id="dropZone">
        <i class="bi bi-file-earmark-arrow-up text-4xl text-blue-500 mb-2"></i>
        <p class="text-gray-700 font-medium">Drop CSV files here or click to select</p>
        <p class="text-sm text-gray-500 mt-1">Supported formats: ZKB, Revolut</p>
        <input type="file" id="fileInput" multiple accept=".csv" class="hidden">
      </div>
      <div id="uploadStatus" class="mt-4"></div>
    </div>
  </div>
</div>

<!-- Tab 2: AI Categorization -->
<div id="categorization-tab" class="settings-content hidden">
  <div class="space-y-6">
    <!-- Statistics Section -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
      <div class="bg-gradient-to-r from-blue-500 to-cyan-500 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="bi bi-bar-chart mr-2"></i>
          Categorization Statistics
        </h2>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="text-center p-4 bg-blue-50 rounded-lg">
            <div class="text-3xl font-bold text-blue-600" id="categorization-rate">-</div>
            <div class="text-sm text-gray-600 mt-1">Categorization Rate</div>
          </div>
          <div class="text-center p-4 bg-green-50 rounded-lg">
            <div class="text-3xl font-bold text-green-600" id="high-confidence-count">-</div>
            <div class="text-sm text-gray-600 mt-1">High Confidence (≥80%)</div>
          </div>
          <div class="text-center p-4 bg-yellow-50 rounded-lg">
            <div class="text-3xl font-bold text-yellow-600" id="medium-confidence-count">-</div>
            <div class="text-sm text-gray-600 mt-1">Medium Confidence (60-79%)</div>
          </div>
          <div class="text-center p-4 bg-purple-50 rounded-lg">
            <div class="text-3xl font-bold text-purple-600" id="manual-corrections-count">-</div>
            <div class="text-sm text-gray-600 mt-1">Manual Corrections</div>
          </div>
        </div>
        
        <button 
          id="recategorize-btn"
          class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-medium transition duration-200 flex items-center justify-center space-x-2"
        >
          <i class="bi bi-arrow-clockwise"></i>
          <span>Re-categorize Uncategorized Transactions</span>
        </button>
        
        <div id="recategorize-status" class="mt-4 hidden"></div>
        
        <div id="categorization-progress" class="mt-4 hidden">
          <div class="bg-gray-200 rounded-full h-2">
            <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <p class="text-sm text-gray-600 mt-2 text-center flex items-center justify-center space-x-2">
            <i class="bi bi-hourglass-split animate-spin"></i>
            <span>Processing transactions...</span>
          </p>
        </div>
      </div>
    </div>

    <!-- Low Confidence Transactions Section -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
      <div class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="bi bi-exclamation-triangle mr-2"></i>
          Low Confidence Predictions
        </h2>
        <p class="text-orange-100 text-sm mt-1">Transactions that may need manual review (sorted by confidence, lowest first)</p>
      </div>
      <div class="p-6">
        <button 
          id="view-low-confidence-btn"
          class="w-full bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg font-medium transition duration-200 flex items-center justify-center space-x-2 mb-4"
        >
          <i class="bi bi-eye"></i>
          <span id="low-confidence-btn-text">Load Low Confidence Transactions</span>
        </button>
        
        <div id="low-confidence-container" class="hidden space-y-4">
          <div id="low-confidence-transactions">
            <!-- Will be populated by JavaScript -->
          </div>
          <button 
            id="hide-low-confidence-btn"
            class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition duration-200"
          >
            Hide Low Confidence Transactions
          </button>
        </div>

        <!-- Manual Categorization Section -->
        <div class="mt-6 border-t pt-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="bi bi-hand-index mr-2"></i>
            Manual Categorization
          </h3>
          <p class="text-sm text-gray-600 mb-4">
            Manually categorize transactions. When you categorize a transaction, all transactions with the same merchant will automatically get the same category.
          </p>
          
          <div class="space-y-3">
            <div class="flex gap-2">
              <input 
                type="text" 
                id="merchant-search" 
                placeholder="Search by merchant name..." 
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
              >
              <button 
                id="search-merchant-btn"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition"
              >
                Search
              </button>
            </div>
            
            <div id="search-results" class="hidden space-y-2">
              <div id="transactions-list"></div>
              <button 
                id="hide-search-btn"
                class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition"
              >
                Hide Results
              </button>
            </div>
          </div>
        </div>

        <!-- Info Box Section -->
        <div class="mt-6 border-t pt-6">
          <button id="info-toggle" class="w-full text-left flex items-center justify-between p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition">
            <span class="flex items-center font-medium text-blue-900">
              <i class="bi bi-info-circle mr-2"></i>
              How Categorization Works
            </span>
            <i class="bi bi-chevron-down text-blue-900 transition-transform" id="info-icon"></i>
          </button>
          
          <div id="info-content" class="hidden mt-4 p-4 bg-blue-50 rounded-lg space-y-4 border border-blue-200">
            <div>
              <h4 class="font-semibold text-blue-900 mb-2">Three-tier Categorization System</h4>
              <ul class="space-y-2 text-sm text-blue-800">
                <li class="flex items-start">
                  <span class="font-bold mr-2">1.</span>
                  <span><strong>Merchant Mapping:</strong> Exact and substring matches from known merchants (100% confidence)</span>
                </li>
                <li class="flex items-start">
                  <span class="font-bold mr-2">2.</span>
                  <span><strong>Keyword Rules:</strong> Pattern-based categorization for common merchants like Netflix, YouTube, Spotify (95% confidence)</span>
                </li>
                <li class="flex items-start">
                  <span class="font-bold mr-2">3.</span>
                  <span><strong>Semantic Matching:</strong> AI-powered similarity matching for new merchants using sentence embeddings (40-90% confidence)</span>
                </li>
              </ul>
            </div>

            <div class="border-t border-blue-200 pt-4">
              <h4 class="font-semibold text-blue-900 mb-2">Confidence Thresholds</h4>
              <div class="space-y-2 text-sm">
                <div class="flex items-center justify-between">
                  <span class="text-blue-800">High Confidence</span>
                  <span class="bg-green-200 text-green-800 px-3 py-1 rounded-full font-semibold">≥ 80%</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-blue-800">Medium Confidence</span>
                  <span class="bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full font-semibold">60% - 79%</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-blue-800">Low Confidence</span>
                  <span class="bg-orange-200 text-orange-800 px-3 py-1 rounded-full font-semibold">&lt; 60%</span>
                </div>
              </div>
            </div>

            <div class="border-t border-blue-200 pt-4">
              <h4 class="font-semibold text-blue-900 mb-2">Special Categories</h4>
              <ul class="space-y-2 text-sm text-blue-800">
                <li><strong>Uncounted:</strong> Legitimate non-spending transactions (internal transfers, exchanges, balance migrations)</li>
                <li><strong>Uncategorized:</strong> Transactions that need manual review or semantic matching</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tab 3: Data Management -->
<div id="data-tab" class="settings-content hidden">
  <div class="space-y-6">
    <!-- Files Section -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
      <div class="bg-gradient-to-r from-green-500 to-emerald-500 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="bi bi-file-earmark mr-2"></i>
          Uploaded Files
        </h2>
      </div>
      <div class="p-6">
        {% if files %}
        <form method="POST" class="space-y-4">
          {% csrf_token %}
          <div class="space-y-2">
            {% for file in files %}
            <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="file" value="{{ file.id }}" 
                     {% if file.id|stringformat:"s" in selected_file_ids %}checked{% endif %}
                     class="w-4 h-4 text-indigo-600 rounded">
              <span class="ml-3 flex-1">
                <span class="font-medium text-gray-900">{{ file.name }}</span>
                <span class="text-sm text-gray-500 block">Uploaded: {{ file.uploaded_at|date:"M d, Y H:i" }}</span>
              </span>
              <button type="button" class="delete-file-btn text-red-600 hover:text-red-800 text-sm" data-file-id="{{ file.id }}">
                Delete
              </button>
            </label>
            {% endfor %}
          </div>
          <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition">
            Update Selection
          </button>
        </form>
        {% else %}
        <p class="text-gray-600 text-center py-8">No files uploaded yet. Start by uploading a bank statement.</p>
        {% endif %}
      </div>
    </div>

    <!-- Currencies Section -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
      <div class="bg-gradient-to-r from-teal-500 to-cyan-500 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="bi bi-currency-exchange mr-2"></i>
          Currencies
        </h2>
      </div>
      <div class="p-6">
        {% if all_currencies %}
        <form method="POST" class="space-y-4">
          {% csrf_token %}
          <div class="space-y-2">
            {% for currency in all_currencies %}
            <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="currency" value="{{ currency }}"
                     {% if currency in selected_currencies %}checked{% endif %}
                     class="w-4 h-4 text-indigo-600 rounded">
              <span class="ml-3 font-medium text-gray-900">{{ currency }}</span>
            </label>
            {% endfor %}
          </div>
          <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition">
            Update Selection
          </button>
        </form>
        {% else %}
        <p class="text-gray-600 text-center py-8">No currencies found in your transactions.</p>
        {% endif %}
      </div>
    </div>

    <!-- Categories Section -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
      <div class="bg-gradient-to-r from-blue-500 to-indigo-500 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center">
          <i class="bi bi-tags mr-2"></i>
          Categories
        </h2>
      </div>
      <div class="p-6">
        {% if all_categories %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          {% for category in all_categories %}
          <div class="px-4 py-2 bg-indigo-50 border border-indigo-200 rounded-lg">
            <span class="text-indigo-800 font-medium">{{ category }}</span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-600 text-center py-8">No categories found in your transactions.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>


<style>
  .settings-tab.active {
    border-bottom-color: #4f46e5;
    color: #4f46e5;
  }
</style>

<script>
  // Tab switching
  document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.dataset.tab;
      
      // Hide all tabs
      document.querySelectorAll('.settings-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.settings-tab').forEach(t => {
        t.classList.remove('active');
        t.style.borderBottomColor = 'transparent';
        t.style.color = '#4b5563';
      });
      
      // Show selected tab
      document.getElementById(tabName + '-tab').classList.remove('hidden');
      
      // Add active class to clicked tab
      this.classList.add('active');
      this.style.borderBottomColor = '#4f46e5';
      this.style.color = '#4f46e5';
      
      // Load stats when categorization tab is clicked
      if (tabName === 'categorization') {
        loadCategorizationStats();
      }
    });
  });

  // Load stats on page load
  function loadCategorizationStats() {
    console.log('loadCategorizationStats called');
    fetch('/api/categorization/stats/')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateCategorizationStatsUI(data.stats);
        }
      })
      .catch(error => console.error('Error loading categorization stats:', error));
  }

  function updateCategorizationStatsUI(stats) {
    document.getElementById('categorization-rate').textContent = 
      stats.categorization_rate.toFixed(1) + '%';
    document.getElementById('high-confidence-count').textContent = stats.high_confidence;
    document.getElementById('medium-confidence-count').textContent = stats.medium_confidence;
    document.getElementById('manual-corrections-count').textContent = stats.manually_categorized;
  }

  function recategorizeUncategorized() {
    const btn = document.getElementById('recategorize-btn');
    const statusDiv = document.getElementById('recategorize-status');
    
    // Show processing state
    btn.disabled = true;
    statusDiv.innerHTML = '<div class="flex items-center space-x-2"><i class="bi bi-arrow-clockwise animate-spin"></i><span>Processing...</span></div>';
    statusDiv.classList.remove('hidden');
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/api/categorization/recategorize/', { 
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json',
      }
    })
      .then(response => response.json())
      .then(data => {
        // Hide spinner and show success message
        statusDiv.innerHTML = `
          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <p class="text-green-800 font-medium mb-2">✓ Successfully categorized ${data.categorized} transactions!</p>
            <ul class="text-sm text-green-700 space-y-1">
              <li>High confidence: ${data.high_confidence}</li>
              <li>Medium confidence: ${data.medium_confidence}</li>
              <li>Low confidence: ${data.low_confidence}</li>
            </ul>
          </div>
        `;
        
        // Refresh stats and low confidence transactions
        setTimeout(() => {
          loadCategorizationStats();
          viewLowConfidenceTransactions();
        }, 500);
      })
      .catch(error => {
        console.error('Error recategorizing:', error);
        statusDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">Error: ${error.message}</div>`;
      })
      .finally(() => {
        btn.disabled = false;
      });
  }

  function viewLowConfidenceTransactions() {
    const container = document.getElementById('low-confidence-container');
    const txContainer = document.getElementById('low-confidence-transactions');
    
    // Show container
    container.classList.remove('hidden');
    
    // Show loading
    txContainer.innerHTML = '<div class="text-center py-8"><i class="bi bi-arrow-clockwise animate-spin text-2xl text-gray-400"></i><p class="text-gray-500 mt-2">Loading transactions...</p></div>';
    
    fetch('/api/categorization/low-confidence/')
      .then(response => response.json())
      .then(data => {
        if (data.success && data.transactions.length > 0) {
          displayLowConfidenceTransactions(data.transactions);
        } else if (data.transactions.length === 0) {
          txContainer.innerHTML = '<div class="text-center py-12"><i class="bi bi-check-circle text-4xl text-green-500 mb-2"></i><p class="text-gray-600 font-medium">No low confidence predictions found!</p><p class="text-sm text-gray-500">All transactions are categorized with good confidence.</p></div>';
        } else {
          txContainer.innerHTML = '<div class="text-center py-4 text-red-500">Error: ' + data.error + '</div>';
        }
      })
      .catch(error => {
        console.error('Error loading low confidence transactions:', error);
        txContainer.innerHTML = '<div class="text-center py-4 text-red-500">Error loading transactions</div>';
      });
  }

  function displayLowConfidenceTransactions(transactions) {
    const container = document.getElementById('low-confidence-transactions');
    
    // Sort by confidence (lowest first)
    const sorted = transactions.sort((a, b) => a.confidence - b.confidence);
    
    let html = '<div class="overflow-x-auto"><table class="w-full text-sm"><thead class="border-b-2 border-gray-200"><tr><th class="text-left py-3 px-3 font-semibold text-gray-700">Date</th><th class="text-left py-3 px-3 font-semibold text-gray-700">Merchant</th><th class="text-left py-3 px-3 font-semibold text-gray-700">Category</th><th class="text-right py-3 px-3 font-semibold text-gray-700">Confidence</th><th class="text-right py-3 px-3 font-semibold text-gray-700">Amount</th></tr></thead><tbody>';
    
    sorted.forEach((transaction) => {
      const confidence = transaction.confidence * 100;
      let confidenceClass = 'bg-red-100 text-red-800';
      if (confidence >= 80) {
        confidenceClass = 'bg-green-100 text-green-800';
      } else if (confidence >= 60) {
        confidenceClass = 'bg-yellow-100 text-yellow-800';
      } else if (confidence >= 40) {
        confidenceClass = 'bg-orange-100 text-orange-800';
      }
      
      html += `
        <tr class="border-b border-gray-100 hover:bg-gray-50">
          <td class="py-3 px-3 text-gray-900">${transaction.date}</td>
          <td class="py-3 px-3 text-gray-900 font-medium">${transaction.booking_text}</td>
          <td class="py-3 px-3"><span class="inline-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded">${transaction.category}</span></td>
          <td class="py-3 px-3 text-right"><span class="inline-block ${confidenceClass} px-3 py-1 rounded-full font-medium">${confidence.toFixed(1)}%</span></td>
          <td class="py-3 px-3 text-right text-gray-900">${parseFloat(transaction.amount).toFixed(2)}</td>
        </tr>
      `;
    });
    
    html += '</tbody></table></div>';
    
    if (sorted.length === 0) {
      html = '<div class="text-center py-12"><i class="bi bi-check-circle text-4xl text-green-500 mb-2"></i><p class="text-gray-600 font-medium">No low confidence predictions found!</p><p class="text-sm text-gray-500">All transactions are categorized with good confidence.</p></div>';
    }
    
    container.innerHTML = html;
  }

  // Event listeners
  document.getElementById('recategorize-btn').addEventListener('click', recategorizeUncategorized);
  document.getElementById('view-low-confidence-btn').addEventListener('click', viewLowConfidenceTransactions);
  document.getElementById('hide-low-confidence-btn').addEventListener('click', function() {
    document.getElementById('low-confidence-container').classList.add('hidden');
  });

  // File upload functionality
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const uploadStatus = document.getElementById('uploadStatus');

  if (dropZone && fileInput) {
    // Click to select files
    dropZone.addEventListener('click', function() {
      fileInput.click();
    });

    // Handle file selection
    fileInput.addEventListener('change', function(e) {
      handleFileUpload(e.target.files);
    });

    // Drag and drop
    dropZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      dropZone.classList.add('bg-blue-200', 'border-blue-400');
    });

    dropZone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      dropZone.classList.remove('bg-blue-200', 'border-blue-400');
    });

    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      dropZone.classList.remove('bg-blue-200', 'border-blue-400');
      handleFileUpload(e.dataTransfer.files);
    });
  }

  function handleFileUpload(files) {
    if (!files || files.length === 0) return;

    const formData = new FormData();
    for (let file of files) {
      formData.append('csv_file', file);
    }

    uploadStatus.innerHTML = '<div class="flex items-center space-x-2"><i class="bi bi-arrow-clockwise animate-spin"></i><span>Uploading and processing...</span></div>';
    uploadStatus.classList.remove('hidden');

    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);

    fetch('/settings/', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': csrfToken
      }
    })
      .then(response => {
        if (response.ok) {
          // Show success message
          uploadStatus.innerHTML = `
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
              <p class="text-green-800 font-medium mb-1">✓ Files uploaded and processed successfully!</p>
              <p class="text-sm text-green-700">Transactions have been imported and categorized.</p>
            </div>
          `;
          
          // Refresh categorization stats after a short delay
          setTimeout(() => {
            loadCategorizationStats();
            // Reload the page to show any server-side messages
            location.reload();
          }, 2000);
        } else {
          uploadStatus.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">Error uploading file. Please try again.</div>';
        }
      })
      .catch(error => {
        console.error('Error uploading file:', error);
        uploadStatus.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4 text-red-800">Error uploading file: ' + error.message + '</div>';
      });
  }

  // Load categorization stats on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadCategorizationStats();
    
    // Setup delete file buttons
    document.querySelectorAll('.delete-file-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const fileId = this.dataset.fileId;
        if (confirm('Are you sure you want to delete this file? This will also delete all associated transactions.')) {
          deleteFile(fileId);
        }
      });
    });
    
    // Setup info toggle
    const infoToggle = document.getElementById('info-toggle');
    const infoContent = document.getElementById('info-content');
    const infoIcon = document.getElementById('info-icon');
    
    if (infoToggle) {
      infoToggle.addEventListener('click', function() {
        infoContent.classList.toggle('hidden');
        infoIcon.style.transform = infoContent.classList.contains('hidden') ? 'rotate(0)' : 'rotate(180deg)';
      });
    }
    
    // Setup manual categorization
    const searchMerchantBtn = document.getElementById('search-merchant-btn');
    const merchantSearch = document.getElementById('merchant-search');
    const searchResults = document.getElementById('search-results');
    const hideSearchBtn = document.getElementById('hide-search-btn');
    
    if (searchMerchantBtn) {
      searchMerchantBtn.addEventListener('click', searchMerchants);
      merchantSearch.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchMerchants();
        }
      });
      
      hideSearchBtn.addEventListener('click', function() {
        searchResults.classList.add('hidden');
        merchantSearch.value = '';
      });
    }
  });
  
  function searchMerchants() {
    const searchTerm = document.getElementById('merchant-search').value.trim();
    if (!searchTerm) {
      alert('Please enter a merchant name to search');
      return;
    }
    
    fetch(`/api/transactions/?category=${encodeURIComponent(searchTerm)}`)
      .then(response => response.json())
      .then(data => {
        const transactions = data.transactions.filter(t => 
          t.booking_text.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        if (transactions.length === 0) {
          document.getElementById('transactions-list').innerHTML = '<p class="text-gray-500">No transactions found with that merchant.</p>';
        } else {
          let html = '<div class="space-y-2">';
          transactions.slice(0, 10).forEach(t => {
            const categoryOptions = [
              'Groceries', 'Dining', 'Shopping', 'Transport', 'Travel',
              'Health', 'Utilities', 'Leisure', 'Car', 'Insurance',
              'Fee', 'Salary', 'Refund', 'Investment', 'Work', 'Donation',
              'Uncounted', 'Bank Transfer', 'Vault', 'Other'
            ];
            
            html += `
              <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1">
                    <p class="font-medium text-gray-900 text-sm">${t.booking_text}</p>
                    <p class="text-xs text-gray-500">${t.date} • ${t.amount} ${t.currency}</p>
                  </div>
                  <span class="text-xs font-semibold px-2 py-1 rounded" id="category-badge-${t.id}"></span>
                </div>
                <div class="flex gap-2">
                  <select class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" 
                          data-transaction-id="${t.id}" 
                          data-merchant="${t.booking_text}">
                    <option value="">-- Select Category --</option>
                    ${categoryOptions.map(cat => `<option value="${cat}" ${t.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                  </select>
                  <button class="apply-category-btn px-3 py-1 text-sm bg-indigo-600 hover:bg-indigo-700 text-white rounded font-medium transition" 
                          data-transaction-id="${t.id}" 
                          data-merchant="${t.booking_text}">
                    Apply
                  </button>
                </div>
              </div>
            `;
          });
          html += '</div>';
          
          if (transactions.length > 10) {
            html += `<p class="text-xs text-gray-500 mt-3">Showing 10 of ${transactions.length} transactions</p>`;
          }
          
          document.getElementById('transactions-list').innerHTML = html;
          
          // Set category badge styles
          transactions.slice(0, 10).forEach(t => {
            const badge = document.getElementById(`category-badge-${t.id}`);
            if (badge) {
              let badgeClass = 'bg-indigo-200 text-indigo-800';
              if (t.category === 'Uncounted') {
                badgeClass = 'bg-gray-300 text-gray-800';
              } else if (t.category === 'Bank Transfer') {
                badgeClass = 'bg-blue-200 text-blue-800';
              }
              badge.className = `text-xs font-semibold px-2 py-1 rounded ${badgeClass}`;
              badge.textContent = t.category || 'Uncategorized';
            }
          });
          
          // Add event listeners to apply buttons
          document.querySelectorAll('.apply-category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const transactionId = this.dataset.transactionId;
              const merchant = this.dataset.merchant;
              const select = document.querySelector(`select[data-transaction-id="${transactionId}"]`);
              const category = select.value;
              
              if (!category) {
                alert('Please select a category');
                return;
              }
              
              applyCategoryToTransaction(transactionId, category, merchant);
            });
          });
        }
        
        document.getElementById('search-results').classList.remove('hidden');
      })
      .catch(error => {
        console.error('Error searching merchants:', error);
        alert('Error searching merchants');
      });
  }
  
  function applyCategoryToTransaction(transactionId, category, merchant) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/api/transactions/${transactionId}/update-category/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        category: category
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(`Category "${category}" applied to this transaction and all ${merchant} transactions!`);
          // Reload search results
          searchMerchants();
          // Reload categorization stats
          loadCategorizationStats();
        } else {
          alert('Error updating category: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error updating category:', error);
        alert('Error updating category');
      });
  }

  function deleteFile(fileId) {
    const btn = document.querySelector(`[data-file-id="${fileId}"]`);
    const row = btn.closest('label');
    
    fetch(`/delete-file/${fileId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Remove the row with animation
        row.style.opacity = '0';
        row.style.transition = 'opacity 0.3s ease';
        setTimeout(() => {
          row.remove();
          // Show success message
          const filesContainer = document.querySelector('form');
          if (filesContainer && filesContainer.querySelectorAll('label').length === 0) {
            filesContainer.innerHTML = '<p class="text-gray-600 text-center py-8">No files uploaded yet. Start by uploading a bank statement.</p>';
          }
        }, 300);
      } else {
        alert('Error deleting file: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error deleting file:', error);
      alert('Error deleting file: ' + error.message);
    });
  }
</script>
{% endblock %}
