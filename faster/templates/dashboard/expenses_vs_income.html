{% extends "base.html" %}
{% load humanize %}

{% block content %}
<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<!-- Header -->
<div class="mb-8">
  <h1 class="text-4xl font-bold text-gray-900 mb-2">
    <i class="bi bi-graph-up-arrow text-indigo-600"></i>
    Analytics Dashboard
  </h1>
  <p class="text-gray-600">Deep dive into your cash flow, spending habits, and recurring expenses.</p>
</div>

<!-- Active Filters Banner -->
<div class="bg-white border-l-4 border-indigo-500 p-4 mb-8 rounded-lg shadow-sm flex items-center justify-between">
  <div class="flex items-center">
    <i class="bi bi-funnel-fill text-indigo-600 text-xl mr-3"></i>
    <div>
      <p class="font-semibold text-gray-800">Active Filters</p>
      <p class="text-sm text-gray-600">
        {% if selected_file_ids %}
        {{ selected_file_ids|length }} file(s) selected
        {% else %}
        All files
        {% endif %}
        |
        {% if selected_currencies %}
        {{ selected_currencies|join:", " }}
        {% else %}
        All currencies
        {% endif %}
      </p>
    </div>
  </div>
  <a href="{% url 'settings' %}" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">
    Change Filters &rarr;
  </a>
</div>

<!-- Main Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">

  <!-- Sankey Diagram (Cash Flow) -->
  <div class="lg:col-span-2 bg-white rounded-xl shadow-md overflow-hidden">
    <div class="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-4">
      <h2 class="text-xl font-bold text-white flex items-center">
        <i class="bi bi-diagram-3-fill mr-2"></i>
        Cash Flow Visualization
      </h2>
    </div>
    <div class="p-4">
      <div id="sankey-chart" class="w-full h-[500px]"></div>
      <p class="text-xs text-gray-500 text-center mt-2">
        Visualizes the flow from Income Sources &rarr; Budget &rarr; Expenses & Savings
      </p>
    </div>
  </div>

  <!-- Subscription Tracker -->
  <div class="bg-white rounded-xl shadow-md overflow-hidden flex flex-col">
    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 px-6 py-4">
      <h2 class="text-xl font-bold text-white flex items-center">
        <i class="bi bi-arrow-repeat mr-2"></i>
        Recurring Expenses
      </h2>
    </div>
    <div class="p-0 flex-1 overflow-y-auto max-h-[500px]">
      {% if subscriptions %}
      <div class="divide-y divide-gray-100">
        {% for sub in subscriptions %}
        <div class="p-4 hover:bg-gray-50 transition">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-semibold text-gray-800 text-sm">{{ sub.name|truncatechars:25 }}</h3>
              <p class="text-xs text-gray-500">{{ sub.count }} payments detected</p>
            </div>
            <div class="text-right">
              <p class="font-bold text-gray-900">CHF {{ sub.avg_amount|floatformat:2 }}</p>
              <p class="text-xs text-gray-400">/ month (est)</p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="p-8 text-center text-gray-500">
        <i class="bi bi-search text-3xl mb-2 block"></i>
        No recurring subscriptions detected in this period.
      </div>
      {% endif %}
    </div>
    <div class="bg-gray-50 p-3 text-center border-t border-gray-100">
      <p class="text-xs text-gray-500">Based on repeated transactions with similar amounts</p>
    </div>
  </div>
</div>

<!-- Spending Heatmap -->
<div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
  <div class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4">
    <h2 class="text-xl font-bold text-white flex items-center">
      <i class="bi bi-calendar-week-fill mr-2"></i>
      Daily Spending Intensity
    </h2>
  </div>
  <div class="p-6">
    <div id="heatmap-chart" class="w-full h-[250px]"></div>
  </div>
</div>

<!-- Transactions Table (Collapsible) -->
<div class="bg-white rounded-xl shadow-md overflow-hidden mb-24">
  <button onclick="toggleSection('transactions')"
    class="w-full bg-gray-100 hover:bg-gray-200 px-6 py-4 flex items-center justify-between transition duration-200">
    <h2 class="text-lg font-bold text-gray-700 flex items-center">
      <i class="bi bi-list-ul mr-2"></i>
      Detailed Transactions List
    </h2>
    <i class="bi bi-chevron-right text-gray-600 text-xl" id="transactions-icon"></i>
  </button>
  <div id="transactions-content" class="hidden p-0">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for tx in transactions %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ tx.Date }}</td>
            <td class="px-6 py-4 text-sm text-gray-900">{{ tx.Booking_text|truncatechars:50 }}</td>
            <td
              class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold {% if tx.Amount < 0 %}text-red-600{% else %}text-green-600{% endif %}">
              {{ tx.Amount|floatformat:2 }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                {{ tx.Category }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Time Filter (Fixed Bottom Right) -->
<div class="fixed bottom-4 right-4 bg-white rounded-lg shadow-xl p-3 border border-gray-200 z-50">
  <div class="flex flex-col gap-2">
    <div class="text-xs font-semibold text-gray-600 mb-1">
      <i class="bi bi-calendar-range text-indigo-600"></i> Time Period
    </div>
    <div class="flex flex-col gap-1">
      <button onclick="setTimeFilter('all')" id="filter-all"
        class="time-filter-btn px-3 py-1.5 rounded text-xs font-medium transition bg-indigo-600 text-white">All
        Time</button>
      <button onclick="setTimeFilter('last_year')" id="filter-last_year"
        class="time-filter-btn px-3 py-1.5 rounded text-xs font-medium transition bg-gray-200 text-gray-700 hover:bg-gray-300">Last
        Year</button>
      <button onclick="toggleCustomDateRange()" id="filter-custom"
        class="time-filter-btn px-3 py-1.5 rounded text-xs font-medium transition bg-gray-200 text-gray-700 hover:bg-gray-300">Custom</button>
    </div>
    <!-- Custom Date Inputs -->
    <div id="customDateInputs" class="hidden mt-2 space-y-2">
      <input type="date" id="startDate" class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
      <input type="date" id="endDate" class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
      <button onclick="applyCustomDateRange()"
        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded text-xs font-medium">Apply</button>
    </div>
  </div>
</div>

<script>
  // --- Data Injection ---
  const sankeyData = JSON.parse('{{ sankey_data|safe }}');
  const heatmapDataRaw = JSON.parse('{{ heatmap_data|safe }}');

  // --- Sankey Chart Initialization ---
  function initSankey() {
    const data = {
      type: "sankey",
      orientation: "h",
      node: {
        pad: 15,
        thickness: 20,
        line: { color: "black", width: 0.5 },
        label: sankeyData.label,
        color: "rgba(79, 70, 229, 0.8)" // Default node color
      },
      link: {
        source: sankeyData.source,
        target: sankeyData.target,
        value: sankeyData.value,
        color: sankeyData.color
      }
    };

    const layout = {
      font: { size: 12, family: "Inter, sans-serif" },
      margin: { l: 10, r: 10, t: 10, b: 10 },
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)"
    };

    Plotly.newPlot('sankey-chart', [data], layout, { displayModeBar: false, responsive: true });
  }

  // --- Heatmap Initialization ---
  function initHeatmap() {
    // Prepare data for Plotly Heatmap (Calendar view approximation)
    // Since true calendar heatmaps are complex in Plotly, we'll use a standard heatmap
    // X-axis: Week of Year, Y-axis: Day of Week

    const dates = Object.keys(heatmapDataRaw).sort();
    const zValues = [];
    const xValues = []; // Week numbers
    const yValues = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

    // Initialize matrix
    // We need to map dates to (week, day) coordinates
    // This is a simplified approach; for a perfect calendar we might need a library like Cal-Heatmap
    // But let's try a simple scatter plot with color scale first, it might look better and be easier

    const xDates = [];
    const yDay = []; // Just 1 for 1D strip? No, let's do a bar chart over time?
    // The user asked for a heatmap.
    // Let's do a standard heatmap: Month on X, Day of Month on Y?

    // Better approach for "Spending Intensity":
    // X: Date, Y: "Spending", Color: Amount? No that's a bar chart.
    // Heatmap: X = Month, Y = Day of Month (1-31), Color = Amount.

    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const days = Array.from({ length: 31 }, (_, i) => i + 1);

    const zMatrix = Array(31).fill().map(() => Array(12).fill(0)); // 31 rows (days), 12 cols (months)
    // Note: This aggregates all years if multiple years selected.

    dates.forEach(dateStr => {
      const date = new Date(dateStr);
      const month = date.getMonth(); // 0-11
      const day = date.getDate() - 1; // 0-30
      zMatrix[day][month] += heatmapDataRaw[dateStr];
    });

    const data = [{
      z: zMatrix,
      x: months,
      y: days,
      type: 'heatmap',
      colorscale: 'Reds',
      hoverongaps: false,
      hovertemplate: 'Month: %{x}<br>Day: %{y}<br>Total: CHF %{z:,.2f}<extra></extra>'
    }];

    const layout = {
      margin: { l: 50, r: 20, t: 20, b: 50 },
      yaxis: { title: 'Day of Month', dtick: 2 },
      xaxis: { title: 'Month' },
      paper_bgcolor: "rgba(0,0,0,0)",
      plot_bgcolor: "rgba(0,0,0,0)"
    };

    Plotly.newPlot('heatmap-chart', data, layout, { displayModeBar: false, responsive: true });
  }

  // --- Initialization ---
  document.addEventListener('DOMContentLoaded', function () {
    initSankey();
    initHeatmap();

    // Initialize Time Filter UI
    const activeFilter = sessionStorage.getItem('timeFilter') || 'all';
    updateTimeFilterUI(activeFilter);
  });

  // --- Helper Functions ---
  function toggleSection(section) {
    const content = document.getElementById(section + "-content");
    const icon = document.getElementById(section + "-icon");
    if (content.classList.contains("hidden")) {
      content.classList.remove("hidden");
      icon.classList.remove("bi-chevron-right");
      icon.classList.add("bi-chevron-down");
    } else {
      content.classList.add("hidden");
      icon.classList.remove("bi-chevron-down");
      icon.classList.add("bi-chevron-right");
    }
  }

  function setTimeFilter(period) {
    sessionStorage.setItem('timeFilter', period);
    sessionStorage.removeItem('customStartDate');
    sessionStorage.removeItem('customEndDate');
    window.location.href = '?time_filter=' + period;
  }

  function updateTimeFilterUI(filter) {
    document.querySelectorAll('.time-filter-btn').forEach(btn => {
      btn.className = 'time-filter-btn px-3 py-1.5 rounded text-xs font-medium transition bg-gray-200 text-gray-700 hover:bg-gray-300';
    });

    if (filter === 'custom') {
      document.getElementById('filter-custom').className = 'time-filter-btn px-3 py-1.5 rounded text-xs font-medium transition bg-indigo-600 text-white';
      document.getElementById('customDateInputs').classList.remove('hidden');

      const start = sessionStorage.getItem('customStartDate');
      const end = sessionStorage.getItem('customEndDate');
      if (start) document.getElementById('startDate').value = start;
      if (end) document.getElementById('endDate').value = end;
    } else {
      const btn = document.getElementById('filter-' + filter);
      if (btn) btn.className = 'time-filter-btn px-3 py-1.5 rounded text-xs font-medium transition bg-indigo-600 text-white';
    }
  }

  function toggleCustomDateRange() {
    const inputs = document.getElementById('customDateInputs');
    if (inputs.classList.contains('hidden')) {
      inputs.classList.remove('hidden');
      updateTimeFilterUI('custom'); // Visually select custom
    } else {
      inputs.classList.add('hidden');
    }
  }

  function applyCustomDateRange() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if (!start || !end) {
      alert('Please select both dates');
      return;
    }
    sessionStorage.setItem('timeFilter', 'custom');
    sessionStorage.setItem('customStartDate', start);
    sessionStorage.setItem('customEndDate', end);
    window.location.href = `?time_filter=custom&start_date=${start}&end_date=${end}`;
  }
</script>
{% endblock %}
