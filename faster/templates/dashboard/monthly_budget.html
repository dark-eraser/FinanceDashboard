{% extends "base.html" %}
{% load humanize %}

{% block content %}
<!-- Hero Section -->
<div class="mb-8">
  <h1 class="text-4xl font-bold  mb-2" style="color: var(--text-primary);">
    <i class="bi bi-calendar-month text-indigo-600"></i>
    Monthly Budget & Trends
  </h1>
  <p class="" style="color: var(--text-secondary);">
    Analyze your spending patterns across categories with historical averages
  </p>
</div>

<!-- Comparison with Toggle Buttons -->
<div class="chart-container">
  <div class="flex flex-col gap-4">
    <div>
      <h3 class="text-lg font-semibold " style="color: var(--text-primary);">Compare Against Average</h3>
      <p class="text-sm  mt-1" style="color: var(--text-secondary);">Select which month to analyze</p>
    </div>
    
    <!-- Toggle Buttons -->
    <div class="flex gap-3">
      <button type="button" 
              data-mode="current" 
              class="comparison-toggle-button px-6 py-3 rounded-lg font-medium border-2 transition"
              onclick="switchComparisonMode('current')">
        <i class="bi bi-calendar-fill mr-2"></i>This Month
      </button>
      <button type="button" 
              data-mode="previous" 
              class="comparison-toggle-button px-6 py-3 rounded-lg font-medium border-2 transition"
              onclick="switchComparisonMode('previous')">
        <i class="bi bi-calendar-range mr-2"></i>Previous Month
      </button>
    </div>
  </div>
</div>

<!-- Current Month Overview -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
  <!-- Month Spending Card (Dynamic) -->
  <div class="chart-container">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium  uppercase month-label" style="color: var(--text-secondary);">This Month's Spending</p>
        <p class="text-3xl font-bold  mt-2" style="color: var(--text-primary);">
          <span class="month-amount">{{ current_month_total|floatformat:0|intcomma }}</span> <span class="text-xl font-semibold " style="color: var(--text-muted);">{{ primary_currency }}</span>
        </p>
        <p class="text-xs  mt-1 month-date" style="color: var(--text-muted);">{{ current_month }}</p>
      </div>
      <div class="bg-red-100 rounded-full p-3">
        <i class="bi bi-calendar-fill text-red-600 text-2xl"></i>
      </div>
    </div>
  </div>

  <!-- Average Monthly Spending -->
  <div class="chart-container">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium  uppercase" style="color: var(--text-secondary);">Average / Month</p>
        <p class="text-3xl font-bold  mt-2" style="color: var(--text-primary);">
          {{ average_spending|floatformat:0|intcomma }} <span class="text-xl font-semibold " style="color: var(--text-muted);">{{ primary_currency }}</span>
        </p>
        <p class="text-xs  mt-1" style="color: var(--text-muted);">Across all categories</p>
      </div>
      <div class="bg-orange-100 rounded-full p-3">
        <i class="bi bi-graph-up text-orange-600 text-2xl"></i>
      </div>
    </div>
  </div>

  <!-- Difference Card (Dynamic) -->
  <div class="chart-container">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium  uppercase" style="color: var(--text-secondary);">Difference from Average</p>
        <p class="text-3xl font-bold mt-2">
          <span class="difference-amount " style="color: var(--text-primary);">{{ current_month_total|floatformat:0|intcomma }}</span> <span class="text-xl font-semibold " style="color: var(--text-muted);">{{ primary_currency }}</span>
        </p>
        <p class="text-xs  mt-1 difference-label" style="color: var(--text-muted);">Over budget</p>
      </div>
      <div class="difference-icon bg-purple-100 rounded-full p-3">
        <i class="bi bi-arrow-up text-purple-600 text-2xl"></i>
      </div>
    </div>
  </div>
</div>

<!-- Average Spending by Category Chart -->
<div class="grid grid-cols-1 lg:grid-cols-1 gap-6 mb-8">
  <!-- Bar Chart -->
  <div class="chart-container">
    <div class="chart-header">
      <h2 class="chart-title">
        <i class="bi bi-bar-chart-fill mr-2"></i>
        Average Spending by Category
      </h2>
    </div>
    <div class="p-6">
      <div class="flex justify-center">
        <div class="w-full" style="height: 600px;">
          <canvas id="averageSpendingChart"></canvas>
        </div>
      </div>
    </div>
  </div>

<!-- Detailed Category Statistics Table -->
<div class="chart-container">
  <div class="chart-header">
    <h2 class="chart-title">
      <i class="bi bi-table mr-2"></i>
      Category Spending Analysis
    </h2>
    <p class="text-green-100 text-sm mt-1">Historical averages and current month spending</p>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead style="background-color: var(--bg-secondary);" class="border-b border-gray-200">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-semibold " style="color: var(--text-primary);">Category</th>
          <th class="month-column px-6 py-3 text-right text-sm font-semibold " style="color: var(--text-primary);">This Month</th>
          <th class="month-column hidden px-6 py-3 text-right text-sm font-semibold " style="color: var(--text-primary);" data-mode="previous">Previous Month</th>
          <th class="px-6 py-3 text-right text-sm font-semibold " style="color: var(--text-primary);">Average</th>
          <th class="px-6 py-3 text-right text-sm font-semibold " style="color: var(--text-primary);">Min</th>
          <th class="px-6 py-3 text-right text-sm font-semibold " style="color: var(--text-primary);">Max</th>
          <th class="px-6 py-3 text-right text-sm font-semibold " style="color: var(--text-primary);">vs Average</th>
          <th class="px-6 py-3 text-right text-sm font-semibold " style="color: var(--text-primary);">Months Tracked</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for item in category_rows %}
          {% if item.is_current_over_budget %}
            <tr class="category-row hover:bg-red-50 transition" data-category="{{ item.category }}" data-current="{{ item.current_amount }}" data-previous="{{ item.previous_amount }}" data-current-over="{{ item.is_current_over_budget }}" data-previous-over="{{ item.is_previous_over_budget }}" data-current-diff="{{ item.current_difference }}" data-previous-diff="{{ item.previous_difference }}">
          {% elif item.current_amount > 0 %}
            <tr class="category-row hover:bg-green-50 transition" data-category="{{ item.category }}" data-current="{{ item.current_amount }}" data-previous="{{ item.previous_amount }}" data-current-over="{{ item.is_current_over_budget }}" data-previous-over="{{ item.is_previous_over_budget }}" data-current-diff="{{ item.current_difference }}" data-previous-diff="{{ item.previous_difference }}">
          {% else %}
            <tr class="category-row hover:bg-gray-100 transition" data-category="{{ item.category }}" data-current="{{ item.current_amount }}" data-previous="{{ item.previous_amount }}" data-current-over="{{ item.is_current_over_budget }}" data-previous-over="{{ item.is_previous_over_budget }}" data-current-diff="{{ item.current_difference }}" data-previous-diff="{{ item.previous_difference }}">
          {% endif %}
            <td class="px-6 py-4">
              <p class="font-medium " style="color: var(--text-primary);">{{ item.category }}</p>
            </td>
            <!-- Current Month Cell -->
            <td class="month-cell px-6 py-4 text-right" data-mode="current">
              <p class=" font-semibold month-value" style="color: var(--text-primary);">
                {% if item.current_amount > 0 %}
                  {{ item.current_amount|floatformat:0|intcomma }}
                {% else %}
                  <span class="text-gray-400">-</span>
                {% endif %}
              </p>
            </td>
            <!-- Previous Month Cell -->
            <td class="month-cell hidden px-6 py-4 text-right" data-mode="previous">
              <p class=" font-semibold month-value" style="color: var(--text-primary);">
                {% if item.previous_amount > 0 %}
                  {{ item.previous_amount|floatformat:0|intcomma }}
                {% else %}
                  <span class="text-gray-400">-</span>
                {% endif %}
              </p>
            </td>
            <td class="px-6 py-4 text-right">
              <p class=" font-semibold" style="color: var(--text-primary);">{{ item.average|floatformat:0|intcomma }}</p>
            </td>
            <td class="px-6 py-4 text-right">
              <p class="" style="color: var(--text-secondary);">{{ item.min|floatformat:0|intcomma }}</p>
            </td>
            <td class="px-6 py-4 text-right">
              <p class="" style="color: var(--text-secondary);">{{ item.max|floatformat:0|intcomma }}</p>
            </td>
            <td class="px-6 py-4 text-right">
              <span class="difference-cell">
                {% if item.current_amount > 0 %}
                  {% if item.is_current_over_budget %}
                    <span class="inline-flex items-center space-x-1 text-red-600 font-semibold current-diff">
                      <i class="bi bi-arrow-up"></i>
                      <span>+{{ item.current_difference|floatformat:0|intcomma }}</span>
                    </span>
                  {% else %}
                    <span class="inline-flex items-center space-x-1 text-green-600 font-semibold current-diff">
                      <i class="bi bi-arrow-down"></i>
                      <span>{{ item.current_difference|floatformat:0|intcomma }}</span>
                    </span>
                  {% endif %}
                {% else %}
                  <span class="text-gray-400 current-diff">-</span>
                {% endif %}
                {% if item.previous_amount > 0 %}
                  {% if item.is_previous_over_budget %}
                    <span class="hidden inline-flex items-center space-x-1 text-red-600 font-semibold previous-diff">
                      <i class="bi bi-arrow-up"></i>
                      <span>+{{ item.previous_difference|floatformat:0|intcomma }}</span>
                    </span>
                  {% else %}
                    <span class="hidden inline-flex items-center space-x-1 text-green-600 font-semibold previous-diff">
                      <i class="bi bi-arrow-down"></i>
                      <span>{{ item.previous_difference|floatformat:0|intcomma }}</span>
                    </span>
                  {% endif %}
                {% else %}
                  <span class="hidden text-gray-400 previous-diff">-</span>
                {% endif %}
              </span>
            </td>
            <td class="px-6 py-4 text-right">
              <p class="" style="color: var(--text-secondary);">{{ item.count }}</p>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="px-6 py-8 text-center " style="color: var(--text-muted);">
              <i class="bi bi-inbox text-4xl mb-2"></i>
              <p class="text-lg font-medium">No spending data available</p>
              <p class="text-sm mt-1">Start by uploading your bank statements</p>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Filters Section -->
<div class="chart-container">
  <div class="chart-header">
    <h2 class="chart-title">
      <i class="bi bi-funnel mr-2"></i>
      Filters
    </h2>
  </div>
  <div class="p-6">
    <form method="POST" class="space-y-4">
      {% csrf_token %}
      
      <!-- File Selection -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Data Sources</label>
        <div class="space-y-2">
          {% for file in files %}
            <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-gray-100 cursor-pointer">
              <input type="checkbox" name="file" value="{{ file.id }}" 
                     {% if file.id|stringformat:"s" in selected_file_ids %}checked{% endif %}
                     class="w-4 h-4 text-indigo-600 rounded">
              <span class="ml-2 " style="color: var(--text-primary);">{{ file.name }}</span>
              <span class="ml-auto text-xs " style="color: var(--text-muted);">{{ file.uploaded_at|date:"M d, Y" }}</span>
            </label>
          {% endfor %}
        </div>
      </div>

      <!-- Currency Selection -->
      {% if all_currencies %}
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Currencies</label>
          <div class="space-y-2">
            {% for currency in all_currencies %}
              <label class="flex items-center p-2 border border-gray-200 rounded-lg hover:bg-gray-100 cursor-pointer">
                <input type="checkbox" name="currency" value="{{ currency }}"
                       {% if currency in selected_currencies %}checked{% endif %}
                       class="w-4 h-4 text-indigo-600 rounded">
                <span class="ml-2 " style="color: var(--text-primary);">{{ currency }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition">
        Update Filters
      </button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Parse chart data
  const chartDataStr = '{{ chart_data|safe|escapejs }}';
  const chartData = JSON.parse(chartDataStr);

  // Create average spending chart
  const ctxAverage = document.getElementById('averageSpendingChart').getContext('2d');
  
  const colors = [
    '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16',
    '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9'
  ];

  new Chart(ctxAverage, {
    type: 'bar',
    data: {
      labels: chartData.labels,
      datasets: [{
        label: 'Average Monthly Spending',
        data: chartData.averages,
        backgroundColor: colors.slice(0, chartData.labels.length),
        borderRadius: 8,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: {
          display: false,
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'CHF ' + context.parsed.x.toLocaleString('en-US', { maximumFractionDigits: 0 });
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value.toLocaleString('en-US', { maximumFractionDigits: 0 });
            },
            color: '#6b7280'
          }
        },
        y: {
          ticks: {
            color: '#6b7280'
          }
        }
      }
    }
  });

  // Helper function to get item from dict in template
  function getItemValue(obj, key) {
    return obj[key] || 0;
  }

  // Toggle comparison mode (current vs previous month)
  let currentComparisonMode = 'current';
  
  function initializeComparison() {
    switchComparisonMode('current');
  }
  
  function switchComparisonMode(mode) {
    currentComparisonMode = mode;
    
    console.log('Switching to mode:', mode);
    
    // Update button styling
    document.querySelectorAll('.comparison-toggle-button').forEach(btn => {
      if (btn.dataset.mode === mode) {
        btn.classList.remove('border-gray-300', 'text-gray-700', 'bg-white');
        btn.classList.add('border-indigo-500', 'text-white', 'bg-indigo-600');
      } else {
        btn.classList.remove('border-indigo-500', 'text-white', 'bg-indigo-600');
        btn.classList.add('border-gray-300', 'text-gray-700', 'bg-white');
      }
    });
    
    // Update the overview cards and table
    updateOverviewCardsForMode(mode);
    updateTableForMode(mode);
  }
  
  function updateOverviewCardsForMode(mode) {
    const monthLabel = document.querySelector('.month-label');
    const monthAmount = document.querySelector('.month-amount');
    const monthDateElem = document.querySelector('.month-date');
    const differenceAmount = document.querySelector('.difference-amount');
    const differenceLabel = document.querySelector('.difference-label');
    const differenceIcon = document.querySelector('.difference-icon');
    
    if (mode === 'current') {
      monthLabel.textContent = "{{ current_month|upper }} SPENDING";
      monthAmount.textContent = '{{ current_month_total|floatformat:0|intcomma }}';
      monthDateElem.textContent = '{{ current_month }}';
      
      const currentTotal = {{ current_month_total }};
      const average = {{ average_spending }};
      const diff = Math.abs(currentTotal - average);
      const isOver = currentTotal > average;
      
      differenceAmount.textContent = diff.toLocaleString('en-US', { maximumFractionDigits: 0 });
      differenceLabel.textContent = isOver ? 'Over average' : 'Under average';
      differenceIcon.className = isOver ? 'bg-red-100 rounded-full p-3' : 'bg-green-100 rounded-full p-3';
      differenceIcon.innerHTML = isOver ? '<i class="bi bi-arrow-up text-red-600 text-2xl"></i>' : '<i class="bi bi-arrow-down text-green-600 text-2xl"></i>';
    } else {
      monthLabel.textContent = "{{ previous_month|upper }} SPENDING";
      monthAmount.textContent = '{{ previous_month_total|floatformat:0|intcomma }}';
      monthDateElem.textContent = '{{ previous_month }}';
      
      const previousTotal = {{ previous_month_total }};
      const average = {{ average_spending }};
      const diff = Math.abs(previousTotal - average);
      const isOver = previousTotal > average;
      
      differenceAmount.textContent = diff.toLocaleString('en-US', { maximumFractionDigits: 0 });
      differenceLabel.textContent = isOver ? 'Over average' : 'Under average';
      differenceIcon.className = isOver ? 'bg-red-100 rounded-full p-3' : 'bg-green-100 rounded-full p-3';
      differenceIcon.innerHTML = isOver ? '<i class="bi bi-arrow-up text-red-600 text-2xl"></i>' : '<i class="bi bi-arrow-down text-green-600 text-2xl"></i>';
    }
  }
  
  function updateTableForMode(mode) {
    // Update month column visibility
    document.querySelectorAll('td.month-cell').forEach(td => {
      if (td.dataset.mode === mode) {
        td.classList.remove('hidden');
      } else {
        td.classList.add('hidden');
      }
    });
    
    // Update row colors based on mode
    document.querySelectorAll('tr.category-row').forEach(row => {
      row.classList.remove('hover:bg-red-50', 'hover:bg-green-50', 'hover:bg-gray-100');
      
      const isOver = mode === 'current' 
        ? row.dataset.currentOver === 'True'
        : row.dataset.previousOver === 'True';
      const amount = mode === 'current'
        ? parseFloat(row.dataset.current)
        : parseFloat(row.dataset.previous);
      
      if (isOver) {
        row.classList.add('hover:bg-red-50');
      } else if (amount > 0) {
        row.classList.add('hover:bg-green-50');
      } else {
        row.classList.add('hover:bg-gray-100');
      }
    });
  }

  // Initialize comparison on page load
  document.addEventListener('DOMContentLoaded', function() {
    initializeComparison();
  });
</script>

<!-- Template filters for dict access -->
<script>
  // Since Django template doesn't have dict access in some versions,
  // we can use this as fallback
</script>
{% endblock %}
